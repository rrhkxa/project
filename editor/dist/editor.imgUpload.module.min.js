define(function(require,exports,module){var c=require("jquery"),p=require("tips"),u=require("imgUploader"),j=require("utils")();j.register({type:"pic",getData:function(a){var a=c(a),b=a.data("data");return{type:"pic",pic:b.src||a.find("img[data-angle]").attr("src")||"",text:a.find("textarea").val().replace(b.defaultText,""),picwidth:b.width,picheight:b.height,angle:b.angle,id:b.id}}});var f=window,h=document;f.setImgInfo=function(a){j.setImgInfo(a)};var q=function(a){this.defaults={cache:{},progress:'[data-query="progress"]',imgCount:'[data-query="imgCount"]',
total:'[data-query="imgTotal"]',cardBox:'[data-query="cardBox"]',addCard:'[data-query="addPic"]',imgUploadBox:'[data-query="imgUploadBox"]',imgMaxWidth:910,uploaderOptions:{server:f.baseUrl+"bbs/post_card_ajax.php?a=upload_pic",swf:f.baseUrl+"bbs/uploadify/Uploader.swf",fileNumLimit:1E6,threads:20,runtimeOrder:"html5,flash",pick:"#file_upload"},getRotate:f.baseUrl+"bbs/post_card_ajax.php?a=rotate_pic",mask:'[data-query="mask"]',isHasQR_code:!0,QR_Server:f.baseUrl+"editor_xbb/qrcodUpload",max:50};
this.options=c.extend(!0,{},this.defaults,a)};q.prototype={init:function(){this.initStyle();this.initUploader();this.bindEvent()},initUploader:function(){var a=this.options;(c.imgCache=a.cache).uploader=u({uploaderOptions:a.uploaderOptions}).init()},bindEvent:function(){var a=this.options.cache,b=this.options,e=this;a.imgCount=0;var g,s,d=a.uploader,f=c(b.progress),k,l,m,i=c('<div style="background-color:#fff;position:absolute;left:0;top:0;right:20px;bottom:0;opacity:0.1;filter:alpha(opacity=10)"></div>'),
t,n;k=l=m="";var q={A:"t37",B:"t36",C:"t20",AB:"t39",BC:"t40",AC:"t41",ABC:"t38"};b.$mask=c(b.mask);a.tempCount=0;a.tempCount1=0;a.tempErrorCount=0;var r=c(b.cardBox);a.imgUploadCallback=[];c(h).on("click",b.addCard,function(v){t||(a.maxPush=!1,a.imgUploadCallback=[],a.imgCount=0<a.tempCount?a.imgCount:0,c(b.total).text(a.tempCount>b.max?b.max:a.tempCount),c(b.imgCount).text(0),c(b.imgUploadBox).css({left:"50%",display:"block"}),b.$mask.show(),b.isHasQR_code&&(a._h&&clearTimeout(a._h),a._h=setTimeout(function(){e.imgCallback();
a._h=setTimeout(arguments.callee,3E3)},3E3)),v.preventDefault())});c(h).on("imgUpload.my",function(a,b,d){setTimeout(function(){var a=p.t6;"success"===d.status&&(n=null,n=c(j.generate({type:"pic",src:d.src,angle:0,id:+new Date,defaultText:a})),r.append(n),/gif$/.test(d.src)&&n.find('a[class^="rotate"]').hide())},0)});c(h).on("click",'[data-query="rotateRight"]',function(a){e.processPic(this);a.preventDefault()});c(h).on("click",'[data-query="rotateLeft"]',function(a){e.processPic(this,!0);a.preventDefault()});
d.on("beforeFileQueued",function(){if(a.maxPush)return!1;if(a.imgCount+1>b.max)return m="C",a.maxPush=!0,!1;a.tempCount++;c(b.total).text(a.tempCount>b.max?b.max:a.tempCount)});d.on("fileQueued",function(){s&&clearTimeout(s);a.imgCount++});d.on("startUpload",function(){t=!0;i.appendTo(b.imgUploadBox)});d.on("uploadFinished",function(){t=!1;i.remove();c(b.imgUploadBox).css({left:"-999999em"});c(b.progress).css({width:0});k+l+m?j.showMessage(p[q[k+l+m]]):c(b.mask).hide();a.tempCount1=a.tempCount=a.tempErrorCount=
0;k=l=m="";setTimeout(function(){n.find("textarea").focus()},1E3);e.setPosition()});d.on("uploadProgress",function(a,c){var b=Math.ceil(100*c.toFixed(2))+"%";f.stop().animate({width:b},3)});d.on("uploadError",function(a){g=a.id;d.removeFile(g,!0);c(h).trigger("my.count")});d.on("uploadSuccess",function(d,e){g=d.id;"success"===e.status?(c(b.imgCount).text(a.tempCount1-a.tempErrorCount+1),c(h).trigger("imgUpload.my",[d,e])):(j.showMessage(e.msg),a.imgCount--)});d.on("uploadComplete",function(){f.stop().css({width:0});
a.tempCount1++;c(h).trigger("my.count")});d.on("error",function(b){"F_EXCEED_SIZE"===b&&(k="A");"Q_TYPE_DENIED"===b&&(l="B");if("F_EXCEED_SIZE"===b||"Q_TYPE_DENIED"===b)a.tempErrorCount++,a.tempCount1++,s=setTimeout(function(){c(h).trigger("my.count")},1E3)})},processPic:function(a,b){var e=c(a).closest("li"),g=e.data("data"),h=e.find("img[data-angle]");this.fetchData({data:{d:b?-90:90,s:g.src,w:g.width,h:g.height}}).done(function(a){"success"===a.status?h.attr("src",a.src):j.showMessage(p.t34)}).fail(function(){j.showMessage(p.t34)})},
fetchData:function(a){a=c.extend(!0,{},{url:this.options.getRotate,type:"POST",dataType:"json",timeout:5E3},a);return c.ajax(a)},getSrc:function(a,b,c,g){return a.split("?")[0]+"?imageMogr2/rotate/"+g+"|imageView2/2/w/"+b+"|watermark/2/text/54ix5Y2h5rG96L2m/font/5b6u6L2v6ZuF6buR/fontsize/300/fill/I0ZGRkZGRg==/dissolve/100/gravity/SouthEast/dx/5/dy/5/"},imgCallback:function(){var a=this.options,b=a.cache;c.ajax({url:a.QR_Server,type:"GET",method:"GET",dataType:"JSON",data:{auth:c("#qrcode_auth").val(),
i:c("#uid_auth").val()},success:function(e){if(!1===e.error&&(e=e.data)){var g=e.length;if(!(1>g)){c(a.total).text(g);for(var f=0;f<g;f++){c(a.imgCount).text(f+1);var d=e[f];c(h).trigger("imgUpload.my",["file",{status:"success",src:d}])}c(a.mask).hide();c(a.imgUploadBox).css({left:"-999999em"});c(a.progress).css({width:0});setTimeout(function(){clearTimeout(b._h)},18E5)}}},error:function(){}})},setPosition:function(){c("html, body").stop(!0,!0).animate({scrollTop:c(h).height()},100)},initStyle:function(){}};
module.exports=function(a){return new q(a)}});
