define(function(require,exports,module){var b=require("jquery"),h=require("artTemplate"),i=require("msgTpl"),n=require("cardTemplate"),p=require("tips"),j=window,k=document,l=function(a){this.defaults={cache:{},ok:'[data-query="ok"]',cancel:'[data-query="cancel"]',close:'[data-query="close"]',mask:'[data-query="mask"]',msgBox:'[data-query="msgBox"]',mBox:'[data-query="mBox"]'};this.options=b.extend(!0,{},this.defaults,a)};l.prototype={constructor:l,cache:{},init:function(){this.initStyle();this.bindEvent();return this},bindEvent:function(){var a=
this.options;b(k).off("click.ko").on("click.ko",a.ok+","+a.cancel,function(c){b(this).closest(a.msgBox).remove();b(a.mask).hide();c.preventDefault()});b(k).off("click.kc").on("click.kc",a.close,function(c){var e=b(this).closest(a.msgBox);0<e.length&&(e.hide(),b(a.mask).hide());c.preventDefault()})},showMessage:function(a,c,e){j.showMegFlag=!0;var d=this.options.cache,f=this.options,g;d.msgRender=d.msgRender?d.msgRender:h.compile(i.message);d.$msgMessage=b(d.msgRender({msg:a})).appendTo("body");b(f.mask).show();
setTimeout(function(){b("#blurFocus1977").focus()},300);b(f.mask).one("click.msk",function(){b(f.mBox).remove();b(this).hide();clearTimeout(g);j.showMegFlag=!1});c||(g=setTimeout(function(){b(f.mBox).remove();b(f.mask).hide();b(f.mask).off("click.msk");j.showMegFlag=!1},e||3E3))},showMsg:function(a,c){var e=this.options,d=h.compile(i.message2);b(d({msg:a})).appendTo("body");b(e.mask).show();setTimeout(function(){b("#blurFocus1977").focus()},300);c&&b(k).on("click",'[data-query="tipsClose"]',function(a){b(e.mask).hide();
b(this).closest(e.msgBox).remove();c();a.preventDefault()})},confirm:function(a){var c=this.options.cache,e=this.options;c.confirmRender=c.confirmRender?c.confirmRender:h.compile(i.confirm);var d=c.confirmRender({title:a.title,okText:a.ok.text,cancelText:a.cancel.text});b(e.mask).appendTo("body").show();d=b(d);c.$cfBox=d.appendTo("body");a.data&&d.data("data",a.data);if(a.ok.fn)d.find(e.ok).one("click",function(c){a.ok.fn();c.preventDefault()});a.cancel.fn&&d.find(e.cancel).one("click",function(c){a.cancel.fn();
c.preventDefault()})},initStyle:function(){1>b(this.options.mask).length&&b(i.mask).appendTo("body");b("#blurFocus1977").remove();b('<input id="blurFocus1977" type="text" style="position:fixed;left:-9999em;top:0;" />').appendTo("body")},generate:function(a){return this["fn"+a.type]&&this["fn"+a.type](a)},register:function(a){var c=this.options.cache;this.constructor.prototype["fn"+a.type]=function(b){var d=a.type+"Render";c[d]=c[d]?c[d]:h.compile(n[a.tml||a.type]);return c[d](b)};this.constructor.prototype["getData"+
a.type]=function(c){var b;return(b=a.getData&&a.getData(c))?b:{}}},getCardData:function(a,c){return this["getData"+a]&&this["getData"+a](c)},getQueryString:function(a){a=RegExp("(^|&)"+a+"=([^&]*)(&|$)");return(a=j.location.search.substring(1).match(a))&&decodeURIComponent(a[2])},getSrc2:function(a,c,b,d){return a.split("?")[0]+"?imageMogr2/rotate/"+d+"/thumbnail/"+c+"x>"},getSrc:function(a,c,b,d){return a.split("?")[0]+"?imageMogr2/rotate/"+d+"|imageView2/2/w/"+c+"|watermark/2/text/54ix5Y2h5rG96L2m/font/5b6u6L2v6ZuF6buR/fontsize/300/fill/I0ZGRkZGRg==/dissolve/100/gravity/SouthEast/dx/5/dy/5/"},
computeStrLength:function(a){if(1>a.length)return 0;a=a.replace(/\[[\:\u4e00-\u9fa5]+\]/g,"xxxx").replace(/[^\w\u4e00-\u9fa5,\n.!?<>\[\]{}\\/~_\-+=%&*()\uff08\uff09@#\u2014\u300a\u300b\uffe5\uff0c\u3002\u3001\uff01\uff1f\u3010\u3011\uff5b\uff5d\u2026]/g,"x").replace(/[^\x00-\xff]/g,"xx");return a.length},getCutEnd:function(a,b){var e=0;if(1>a.length)return 0;for(var a=a.replace(/\[[\:\u4e00-\u9fa5]+\]/g,"xxxx"),d=/[^\x00-\xff]/,f=0,g=a.length;f<g&&!(d.test(a[f])?e+=2:e++,e>b);f++);return f},setImgInfo:function(a){var c=
a.naturalWidth||a.width,e=a.naturalHeight||a.height,d,f;d=960<c?960:c;c=Math.round(d/c*e);e=(f=a.src.match(/rotate\/(\d+)\|/))&&+f[1]||0;f=b(a).closest("li");b(a).closest("li").data("data",{width:d,height:c,src:a.src,angle:e,type:"pic",defaultText:p.t6,id:f.attr("data-id")})},setPosition:function(){b("html, body").stop(!0,!0).animate({scrollTop:b(k).height()},100)}};module.exports=function(a){return(new l(a)).init()}});
