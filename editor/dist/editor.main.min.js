define(function(require,exports,module){var $=require("jquery"),tools=require("utils")(),tips=require("tips"),baseTools=require("tools");require("xsortable");
var win=window,doc=document,pos=require("pos"),fn=function(a){this.defaults={cache:{},id:'[data-query="draftId"]',cid:'[data-query="cid"]',title:'[data-query="title"]',cardBox:'[data-query="cardBox"]',submit:'[data-query="submit"]',msgDraftBox:'[data-query="msgDraftBox"]',ok:'[data-query="ok"]',cancel:'[data-query="cancel"]',close:'[data-query="close"]',mask:'[data-query="mask"]',browBox:'[data-query="browBox"]',preview:'[data-query="preview"]',server:{autoSave:window.baseUrl+"editor_xbb/autosave",
submit:win.baseUrl+"editor_xbb/doPost",clearDraft:win.baseUrl+"bbs/post_card_ajax.php?a=clean_draft",url:win.baseUrl+"xbb/",preview:win.baseUrl+"editor_xbb/showInfo/",editLoad:win.baseUrl+"bbs/post_card_ajax.php"},pid:'[data-query="pid"]',msgBox:'[data-query="msgBox"]'};this.options=$.extend(!0,{},this.defaults,a)};
fn.prototype={init:function(){this.options.cache.uid=baseTools.getCookie("_discuz_uid")||11111111111;this.initStyle();this.bindEvent();this.editModeLoad()},bindEvent:function(){var a=this,b=this.options,c=b.cache,e=$("#toolbar").closest("div"),d=e.offset().top;$(doc).on("click","#btn_load_draft",function(a){$(doc).trigger("xbb.edit",[0]);a.preventDefault()});var f=e.clone(!0);f.css({position:"fixed",left:"-9999em",top:"-20px",width:"915px","margin-left":"-478px"}).appendTo("body");$(b.title).on("focus",
function(a){win.showMegFlag?this.blur():($.trim(this.value)===tips.t22&&(this.value=""),61>tools.computeStrLength(this.value)?$(this).css({border:"1px solid #e4e4e4"}):$(this).css({border:"1px solid red"}))}).on("blur",function(){this.value=$.trim(this.value)?this.value:tips.t22;60<tools.computeStrLength(this.value)?($(this).css({border:"1px solid red"}),$(b.browBox).hide(),tools.showMessage(tips.t14)):$(this).css({border:"1px solid #e4e4e4"})});$(doc).on("click",'[data-query="cancelVideoUrl"]',function(a){$(b.mask).hide();
$("#bomb_box_video").hide();a.preventDefault()});$(win).on("scroll",function(){$(win).scrollTop()>d?(!c.d&&f.css({left:"50%"}).show(),c.t=!1,c.d=!0):(!c.t&&f.css({left:"-99999em"}).hide(),c.t=!0,c.d=!1)});$(b.cardBox).on("click",b.close,function(a){var c=$(this).closest("li"),d=c.data("data"),e=c.attr("data-type");if("text"!==e)tools.confirm({title:tips.t19,ok:{text:"\u786e\u5b9a",fn:function(){c.remove();$(doc).trigger("deleteCard",[e]);var a=$(b.cardBox).find("textarea");pos.save(a.eq(a.length-
1)[0])}},cancel:{text:"\u53d6\u6d88"},data:"card"});else{var f=$.trim(c.find("textarea").val());f!==d.defaultText&&f?tools.confirm({title:tips.t19,ok:{text:"\u786e\u5b9a",fn:function(){c.remove();$(doc).trigger("deleteCard",[e]);var a=$(b.cardBox).find("textarea");pos.save(a.eq(a.length-1)[0])}},cancel:{text:"\u53d6\u6d88"},data:"card"}):(c.remove(),d=$(b.cardBox).find("textarea"),pos.save(d.eq(d.length-1)[0]))}a.preventDefault()});$(doc).on("click",b.preview,function(d){if(!c.preview){var e=a.getData();
a.check(e,!0)&&(c.preview=!0,a.fetchData(b.server.autoSave,e).done(function(a){$(b.id).val(a.id);win.open(win.baseUrl+b.server.preview+a.id)}).fail(function(){delete c.preview}),d.preventDefault())}});$(b.cardBox).on("focusin","textarea",function(){if(win.showMegFlag)this.blur();else{$(this).css({border:"1px solid #e4e4e4"});var a=$.trim(this.value),b=$(this).closest("li").data("data");if(b)a===b.defaultText&&(this.value="",$(this).addClass("txt-writing"));else this.value=""}}).on("blur","textarea",
function(){var a=$.trim(this.value),c=$(this).closest("li").data("data");if(c){var d=c.defaultText;a||(this.value=d,$(this).removeClass("txt-writing"));a="text"===c.type?16E3:500;d="video"===c.type||"videoUrl"===c.type?tips.t28:tips.t26;d="text"===c.type?tips.t32:d;tools.computeStrLength(this.value)>a&&($(this).css({border:"1px solid red"}),$(b.browBox).hide(),tools.showMessage(d))}});$(doc).on("click",b.submit,function(b){a.postData(!0);b.preventDefault()});$("#sortable").xsortable({axis:"y",handle:".drag_drop",
helper:"clone",placeholder:"ui-state-highlight"})},getData:function(){var a=this.options,b=[];$(a.cardBox).find("li[data-type]").each(function(){var a=$(this).data("data");if("text"===a.type){var e=$.trim($(this).find("textarea").val());if(e===a.defaultText||!e)return!0}b.push(tools.getCardData(a.type,this))});return{content:b,subject:$(a.title).val().replace(tips.t22,"")}},postData:function(a){var b=this.options.cache,c=this.getData(),e=$("#fid").val(),d=$("#extra").val();$("#sign").val();var f=
"bbs/post.php?action=newthread&topicsubmit=yes&fromcard=1&htmlon=10&big_task=yes&fid="+e+"&extra="+encodeURIComponent(d),k="edit"===tools.getQueryString("a"),l=tools.getQueryString("pid"),n=tools.getQueryString("tid");f=k?"bbs/post.php?action=edit&editsubmit=yes&fromcard=1&htmlon=10&fid="+e+"&tid="+n+"&pid="+l+"&extra="+encodeURIComponent(d):f;b.submit||this.check(c,a)&&(b.submit=!0,this.formPost({action:win.baseUrl+f,method:"post",data:[{name:"subject",value:this.htmlFilter(c.subject)},{name:"message",
value:this.convert(c.content)},{name:"formhash",value:$("#formhash").val()},{name:"task_id",value:$("#task_id").val()}]}))},check:function(a,b){var c=/^[^\w\u4e00-\u9fa5,\.\!\?\[\]{}\uff08\uff09\\/~_\-\+\=%&*()@#\u2014\u300a\u300b\uffe5\uff0c"\u201c\u201d;^$\uff1b'\u2018\uff1a:\u3002\u3001\uff01\uff1f\u3010\u3011\uff5b\uff5d\u2026]+$/,e=0,d=[],f=!0;if(!a.subject.replace(/<\/?[a-zA-Z][^>]*>/g,""))return b&&tools.showMessage(tips.t12),$(this.options.title).val(tips.t22),!1;if(60<tools.computeStrLength(a.subject))return b&&
tools.showMessage(tips.t14),!1;if(1>a.content.length)return b&&tools.showMessage(tips.t13),!1;if(c.test(a.subject))return b&&tools.showMessage(tips.t33),$(this.options.title).val(tips.t22),!1;for(var k=0,l=a.content.length;k<l;k++){b=a.content[k];if("pic"===b.type&&(f=!1,500<tools.computeStrLength(b.text)))return tools.showMessage(tips.t26),!1;if("video"===b.type&&(f=!1,500<tools.computeStrLength(b.text)))return tools.showMessage(tips.t28),!1;if("text"===b.type){if(16E3<tools.computeStrLength(b.text))return tools.showMessage(tips.t25),
!1;if(!b.text.replace(/<\/?[a-zA-Z][^>]*>|\n/g,""))return $('[data-id="'+b.id+'"]').find("textarea").val(tips.t7),tools.showMessage(tips.t13),!1;f=f?c.test(b.text)&&++e&&d.push(b.id):!1}}(f=f&&1>$('[data-type="pic"],[data-type="video"]').length)&&tools.showMessage(tips.t13);if(e){a=$('[data-id="'+d[0]+'"]').find("textarea");if(1<e)for(e=d.length,c=1;c!==e;c++)$('[data-id="'+d[c]+'"]').remove();if(!f)return!0;a.val(tips.t7).text(tips.t7);a.css({border:"1px solid red"});tools.showMessage(tips.t35);
return!1}return!0},fetchData:function(a,b){return $.ajax({type:"POST",method:"POST",url:a,data:b,dataType:"json"})},formPost:function(a){var b=this.options.cache,c=this.options,e=a.method||"get",d=a.charset&&"accept-charset"+a.charset||"",f="",k=a.action||"";if(!b.isSubmit){for(var l=0,n=a.data.length;l<n;l++)f+='<input type="hidden"  />';e=$('<form action="'+k+'" method="'+e+'" '+d+">"+f+"</form>").appendTo("body");e.find("input").each(function(b){this.value=a.data[b].value;this.name=a.data[b].name});
b.isSubmit=!0;$(c.submit).css({cursor:"default",background:"gray","border-radius":"4px"});e[0].submit()}},convert:function(a){for(var b="",c,e=/[^\w\u4e00-\u9fa5,.!?\s\[\]{}\\/~_\-+=%&*()\uff08\uff09@#\u2014\u300a\u300b\uffe5^$\uff0c"\u201c\u201d'\u2018\u2019\uff1a:\u3002\u3001\uff01\uff1f\u3010\u3011\uff5b\uff5d\u2026]/g,d=0,f=a.length;d<f;d++)"text"===a[d].type?b+=this.htmlFilter(a[d].text)?"[textcard]"+this.htmlFilter(a[d].text)+"[/textcard]":"":(c=1>a[d].text.replace(/<\/?[a-zA-Z][^>]*>|\n/g,
"").replace(e,"").length?"":"[mtip]"+this.htmlFilter(a[d].text)+"[/mtip]","pic"===a[d].type?b+="[piccard][img="+a[d].picwidth+","+(a[d].picheight||960)+"]"+a[d].pic+"[/img]"+c+"[/piccard]":"video"===a[d].type&&(b+="[videocard][video_src]"+a[d].video+"[/video_src]"+c+"[/videocard]"));return b},htmlFilter:function(a){return a.replace(/(\n|<br[^>]*>){3,}/g,"\n\n\n").replace(/\u0020{2,}/g," ").replace(/<\/?[a-zA-Z][^>]*>/g,"").replace(/[^\w\u4e00-\u9fa5,\:.!?\s\[\]{}\\/~_\-+=%&*()\uff08\uff09@#\u2014\u300a\u300b\uffe5\uff0c^$"\u201c\u201d\u2018\u2019'\uff1a;\uff1b\u3002<>\u3001\uff01\uff1f\u3010\u3011\uff5b\uff5d\u2026]/g,
"")},convertDataStr:function(a){a=a.replace(/[\r\n\t]/g,"");a=a.match(/\[(\w+)card\][\s\S]*?\[\/\1card\]/g)||[];for(var b=[],c=/\[mtip\]([\s\S]*?)\[\/mtip\]/,e=/\[video_src\]([\s\S]*?)\[\/video_src\]/,d=/\[img\=(\d+),(\d+)\](\S+?)(?:-w(\d+)wm(\d)\.\w+)*\[\/img\]/,f=/^\[textcard\][\s\S]+?/,k=/^\[piccard\][\s\S]+?/,l=/^\[videocard\][\s\S]+?/,n=/\[textcard\]([\s\S]*?)\[\/textcard\]/,q=/<br[^>]*>/g,g,m,h,p=0,r=a.length;p<r;p++)g={},b.push(g),m=a[p],g.type=f.test(m)?"text":k.test(m)?"pic":l.test(m)?"video":
"unknow",g.text="text"===g.type?(h=m.match(n))&&h[1]:(h=m.match(c))&&h[1],g.text=g.text&&g.text.replace(q,"\n")||"",g.video=(h=m.match(e))&&h[1],g.pic=(h=m.match(d))&&h[3],g.pic&&(g.picwidth=h[1],g.picheight=h[2],g.angle=h[5]);return b},editModeLoad:function(){var a=this,b=this.options,c=b.cache;if("edit"===tools.getQueryString("a")){var e=tools.getQueryString("pid");$.ajax({type:"GET",method:"GET",url:b.server.editLoad,dataType:"json",data:{pid:e,a:"load_post"},success:function(b){if(!b.error){c.uid=
b.uid;$(doc).trigger("updateUid",[c.uid]);var d=a.convertDataStr(b.content);d.title=b.title;$(doc).trigger("xbb.load",[d])}},error:function(){}})}},initStyle:function(){$('<style type="text/css">.webuploader-pick {position: relative;display: inline-block;cursor: pointer;background: transparent;padding: 1px 34px;color: #fff;text-align: center;border-radius: 3px;overflow: hidden;}.progress_num{width:0}div.bomb_box_face{z-index:140}.f_p_seach .text{width:743px;}</style>').appendTo("body")}};
module.exports=function(a){return new fn(a)};})
